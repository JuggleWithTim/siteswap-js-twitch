const SiteswapJS=function(){"use strict";function t(t,i,s){if(this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),"string"==typeof i&&0!==i.length)if(this.options=this.setDefaultOptions(s),this.options.siteswap=i.toLowerCase(),this.options.width=this.canvas.width,this.options.height=this.canvas.height,this.paused=!1,this.startTime=Date.now(),this.frameDuration=1e3/this.options.fps,this.lag=0,this.juggler=new u(this.options),this.options.exportGif){this.initGifEncoder(),this.gifTest=0;for(var e=0;e<10*this.juggler.patternLength;e++)this.update()}else this.options.controls&&this.addListeners()}function i(t){this.timeUnit=t,this.maxR=2.5,this.i=0,this.x=0,this.y=0,this.px=0,this.py=0,this.r=0}t.prototype.loop=function(t){const i=Date.now(),s=i-t.startTime;t.startTime=i,t.lag+=s,t.update(),t.lag-=t.frameDuration,t.draw(),t.paused||window.requestAnimationFrame((function(){t.loop(t)}))},t.prototype.update=function(){this.juggler.update()},t.prototype.draw=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.options.backgroundColour&&(this.ctx.fillStyle=this.options.backgroundColour,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)),this.juggler.draw(this.ctx),this.options.debug&&(this.ctx.font="24px Arial",this.ctx.fillStyle="black",this.ctx.fillText("r: "+Math.round(this.juggler.rotation),10,this.canvas.height-10)),this.options.exportGif&&(this.gifTest++<this.juggler.patternLength?this.gifEncoder.addFrame(this.ctx):this.gifTest===this.juggler.patternLength+1&&this.finishGifEncoder())},t.prototype.setDefaultOptions=function(t){return"c"===(t=Object.assign({fps:60,throwsPerSecond:3,propType:"b",exportGif:!1,spinOn0s:!1,spinOn2s:!1,headBounce:!1,clubBalance:!1,debug:!1,controls:!1},t)).propType&&(t.controls=!1),t},t.prototype.initGifEncoder=function(){if("function"!=typeof GIFEncoder)throw new Error("GIFEncoder not found");this.gifEncoder=new GIFEncoder,this.gifEncoder.setRepeat(0),this.gifEncoder.setDelay(40),this.gifEncoder.start()},t.prototype.finishGifEncoder=function(){this.gifEncoder.finish();const t=this.gifEncoder.stream().getData(),i="data:image/gif;base64,"+encode64(t);document.getElementById("gif-output").src=i},t.prototype.start=function(){const t=this;window.requestAnimationFrame((function(){t.loop(t)}))},t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1,this.start()},t.prototype.stop=function(){this.paused=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.getJuggler=function(){return this.juggler},t.prototype.addListeners=function(){const t=this;let i=0,s=!1;const e=t=>{s=!0,i=t.screenX||t.changedTouches[0].screenX},h=e=>{if(e.stopPropagation(),s){const s=e.screenX||e.changedTouches[0].screenX,h=s-i;i=s,t.juggler.rotate(h)}},n=()=>{s=!1};this.canvas.addEventListener("touchstart",e),this.canvas.addEventListener("mousedown",e),document.addEventListener("touchmove",h),document.addEventListener("mousemove",h),document.addEventListener("touchend",n),document.addEventListener("mouseup",n),this.canvas.addEventListener("dblclick",(()=>{t.juggler.rotation=0}))},i.prototype.update=function(t,i){const s=Math.sin(this.i*Math.PI/(4*this.timeUnit));this.r=s*this.maxR;const e=90-Math.abs(this.r)/2,h=13*t/80*i*Math.sin(Math.PI*this.r/360)/2;this.px=2*h*Math.sin(e*Math.PI/180),this.py=2*h*Math.cos(e*Math.PI/180),this.x=-t*s*i/200,this.i++},i.prototype.draw=function(t,i,s,e,h){r(t,i+this.x+this.px,s+this.y+this.py,0,this.r,e,h)},i.prototype.getHeadReaction=function(){return this.x};const s=(t,i,s,n,o,l,p,c)=>{"b"==i?e(t,s,n,p,c):"c"==i?r(t,s,n,o,l,p,c):"r"==i?h(t,s,n,0,o,p,c):a(t,s,n,o,p,c)},e=(t,i,s,e,h,n,o=0)=>{const a=e*h/80;t.beginPath(),t.ellipse(i,s,Math.abs(Math.cos(o/180*Math.PI))*a,a,0,2*Math.PI,!1),t.fillStyle=n||"#8BC34A",t.fill(),t.strokeStyle="#333333",t.stroke()},h=(t,i,s,e,h,n,o)=>{h%=360;const a=o*n/10,r=Math.sin(h/180*Math.PI),l=Math.cos(h/180*Math.PI);function p(i){t.beginPath(),t.moveTo(l*i+r*-a/2,0),t.bezierCurveTo(l*i+r*-a/2,2*a/3,l*i+r*a/2,2*a/3,l*i+r*a/2,0),t.bezierCurveTo(l*i+r*a/2,-2*a/3,l*i+r*-a/2,-2*a/3,l*i+r*-a/2,0),t.lineTo(l*i+-2*r*a/5,0),t.bezierCurveTo(l*i+-2*r*a/5,8*a/15,l*i+2*r*a/5,8*a/15,l*i+2*r*a/5,0),t.bezierCurveTo(l*i+2*r*a/5,-8*a/15,l*i+-2*r*a/5,-8*a/15,l*i+-2*r*a/5,0),t.stroke(),t.beginPath(),t.moveTo(l*i+r*-a/2,0),t.bezierCurveTo(l*i+r*-a/2,2*a/3,l*i+r*a/2,2*a/3,l*i+r*a/2,0),t.lineTo(l*i+2*r*a/5,0),t.bezierCurveTo(l*i+2*r*a/5,8*a/15,l*i+-2*r*a/5,8*a/15,l*i+-2*r*a/5,0),t.fill(),t.beginPath(),t.moveTo(l*i+r*-a/2,0),t.bezierCurveTo(l*i+r*-a/2,-2*a/3,l*i+r*a/2,-2*a/3,l*i+r*a/2,0),t.lineTo(l*i+2*r*a/5,0),t.bezierCurveTo(l*i+2*r*a/5,-8*a/15,l*i+-2*r*a/5,-8*a/15,l*i+-2*r*a/5,0),t.fill()}t.save(),t.rotate(l*e/180*Math.PI),t.translate(i,s),t.lineWidth=2,t.strokeStyle="#333333",t.fillStyle="#9999FF",h<=180&&(p(a/100),p(0),p(-a/100)),h>180&&(p(-a/100),p(0),p(a/100)),t.restore()},n=new Image,o=new Image,a=(t,i,s,e,h,a,r,l)=>{const p=l?n:o,c=Math.abs(Math.cos(r/180*Math.PI)),u=h*a/40;t.save(),t.translate(i,s),t.rotate(e/180*Math.PI),t.scale(c*u/p.width,u/p.width),t.drawImage(p,-p.width/2,-p.width/2),t.restore()},r=(t,i,s,e,h,n,o)=>{e%=360;const a=13*n/80*o,r=21*n/800*o,l=Math.cos(e/180*Math.PI),p=1.4*Math.sin(e/180*Math.PI);t.save(),t.translate(i,s),t.rotate(h/180*Math.PI),t.strokeStyle="#333333",t.beginPath(),e<270&&(t.moveTo(-r/5,11*l*a/24),t.bezierCurveTo(-r/5,11*l*a/24+p*r/5,r/5,11*l*a/24+p*r/5,r/5,11*l*a/24)),(e<180||e>=270)&&(t.moveTo(r/5,11*l*a/24),t.bezierCurveTo(r/5,11*l*a/24-p*r/5,-r/5,11*l*a/24-p*r/5,-r/5,11*l*a/24)),t.moveTo(-r/5,11*l*a/24),t.lineTo(-r/5,l*a/2),t.moveTo(r/5,11*l*a/24),t.lineTo(r/5,l*a/2),e<270&&(t.moveTo(-r/5,l*a/2),t.bezierCurveTo(-r/5,l*a/2+p*r/5,r/5,l*a/2+p*r/5,r/5,l*a/2)),(e<180||e>=270)&&(t.moveTo(r/5,l*a/2),t.bezierCurveTo(r/5,l*a/2-p*r/5,-r/5,l*a/2-p*r/5,-r/5,l*a/2)),t.stroke(),(e<267||e>273)&&(t.beginPath(),t.moveTo(-r/5,0),t.lineTo(-r/7,11*l*a/24),t.moveTo(r/5,0),t.lineTo(r/7,11*l*a/24),e<270&&(t.moveTo(-r/7,11*l*a/24),t.bezierCurveTo(-r/7,11*l*a/24+p*r/7,r/7,11*l*a/24+p*r/7,r/7,11*l*a/24)),(e<180||e>=270)&&(t.moveTo(r/7,11*l*a/24),t.bezierCurveTo(r/7,11*l*a/24-p*r/7,-r/7,11*l*a/24-p*r/7,-r/7,11*l*a/24)),t.stroke()),t.beginPath(),(e<258||e>282)&&(e>=90&&e<270&&(t.moveTo(-r/5,0),t.bezierCurveTo(-r/5,p*r/5,r/5,p*r/5,r/5,0)),(e<90||e>=270)&&(t.moveTo(r/5,0),t.bezierCurveTo(r/5,-p*r/5,-r/5,-p*r/5,-r/5,0)),(e<=82||e>=98)&&(t.moveTo(-r/5,0),t.lineTo(-r/2,-2*l*a/10),t.moveTo(r/5,0),t.lineTo(r/2,-2*l*a/10))),e>82&&e<270&&(t.moveTo(-r/2,-2*l*a/10),t.bezierCurveTo(-r/2,-2*l*a/10+p*r/2,r/2,-2*l*a/10+p*r/2,r/2,-2*l*a/10)),(e<98||e>=270)&&(t.moveTo(r/2,-2*l*a/10),t.bezierCurveTo(r/2,-2*l*a/10-p*r/2,-r/2,-2*l*a/10-p*r/2,-r/2,-2*l*a/10)),t.stroke(),t.beginPath(),(e<76||e>104)&&(t.moveTo(-r/2,-2*l*a/10),t.lineTo(-r/2,-3*l*a/10),t.moveTo(r/2,-2*l*a/10),t.lineTo(r/2,-3*l*a/10)),e>=90&&e<282&&(t.moveTo(-r/2,-3*l*a/10),t.bezierCurveTo(-r/2,-3*l*a/10+p*r/2,r/2,-3*l*a/10+p*r/2,r/2,-3*l*a/10)),(e<90||e>258)&&(t.moveTo(r/2,-3*l*a/10),t.bezierCurveTo(r/2,-3*l*a/10-p*r/2,-r/2,-3*l*a/10-p*r/2,-r/2,-3*l*a/10)),(e<=258||e>=282)&&(e<80||e>100)&&(t.moveTo(-r/2,-3*l*a/10),t.lineTo(-r/4,-5*l*a/10),t.moveTo(r/2,-3*l*a/10),t.lineTo(r/4,-5*l*a/10)),(e<80||e>100)&&(e>=90&&(t.moveTo(-r/4,-5*l*a/10),t.bezierCurveTo(-r/4,-5*l*a/10+p*r/4,r/4,-5*l*a/10+p*r/4,r/4,-5*l*a/10)),(e<90||e>=180)&&(t.moveTo(r/4,-5*l*a/10),t.bezierCurveTo(r/4,-5*l*a/10-p*r/4,-r/4,-5*l*a/10-p*r/4,-r/4,-5*l*a/10))),t.stroke(),t.restore()},l=(t,i,e,h,n,o,a,r,l,p,c)=>{h%=360;const u=n*o/4,f=n*o/8,g=Math.cos(h/180*Math.PI),d=Math.sin(h/180*Math.PI);function m(){const i=g*(r.left.x-6*f/8)+d*u/3,e=-5*u/50+r.left.y;if(t.beginPath(),t.moveTo(g*-f/2,-5*u/8),t.lineTo(g*(-r.left.x/8-6*f/8),-u/7),t.lineTo(i,e),t.stroke(),p.left){const i="r"===l?u/20:1===p.left?0:r.left.y,a=g*(r.left.x-6*f/8)+d*("r"===l?u/2:u/3),c=e-("r"===l?0:i/2);for(let e=0;e<p.left;e++){const u=a+("r"===l?e*(i/p.left):0);let f=c+("r"===l?0:e*(i/p.left)),g=h;"c"===l&&(g=270-.5*r.left.y,f+=.5*r.left.y),s(t,l,u,f,g,0,n,o)}}}function y(){const i=g*(r.right.x+6*f/8)+d*u/3,e=-5*u/50+r.right.y;if(t.beginPath(),t.moveTo(g*f/2,-5*u/8),t.lineTo(g*(6*f/8-r.right.x/8),-u/7),t.lineTo(i,e),t.stroke(),p.right){const i="r"===l?u/20:1===p.right?0:r.right.y,a=g*(r.right.x+6*f/8)+d*("r"===l?u/2:u/3),c=e-("r"===l?0:i/2);for(let e=0;e<p.right;e++){const u=a+("r"===l?e*(i/p.right):0);let f=c+("r"===l?0:e*(i/p.right)),g=h;"c"===l&&(g=270-.5*r.right.y,f+=.5*r.right.y),s(t,l,u,f,g,0,n,o)}}}t.save(),t.translate(i,e),t.strokeStyle="#333333",t.fillStyle="#FFDAC8",t.beginPath(),t.moveTo(-5*g*u/36+c,-33*u/40+a),t.bezierCurveTo(-5*g*u/36+c,-41*u/40+a,5*g*u/36+c,-41*u/40+a,5*g*u/36+c,-33*u/40+a),t.bezierCurveTo(5*g*u/36+c,-25*u/40+a,-5*g*u/36+c,-25*u/40+a,-5*g*u/36+c,-33*u/40+a),t.fill(),t.stroke(),h>=180?m():y(),t.fillStyle="#BDBDBD",t.beginPath(),t.moveTo(g*-f/2,-5*u/8),t.lineTo(g*f/2,-5*u/8),t.lineTo(7*g*f/20,0),t.lineTo(-7*g*f/20,0),t.lineTo(g*-f/2,-5*u/8),t.fill(),t.stroke(),h<180?m():y(),t.restore()};function p(t){if(this.siteswap=t.replace(/\s/g,""),this.left=[],this.right=[],this.type="",this.max=0,this.number=0,this.valid=this.validateSiteswap(),this.catches={},this.holding={left:0,right:0},!this.valid)throw new Error("Invalid siteswap");this.sync="synchronous"===this.type||"synchronous multiplex"===this.type,this.period=this.left.length,this.initCatches(),this.initHolding(),this.leftIndex=0,this.rightIndex=0,this.positions={left:{x:0,y:0},right:{x:0,y:0}},this.positionQueue={left:{x:[0],y:[0]},right:{x:[0],y:[0]}},this.spinning=!1}function c(t,i,s,e){this.beatLength=2,this.beatIndex=0,this.beats=[];const h=(t,i=[])=>{const s=i.map((t=>t.value)).join();return s===t||s.charAt(0)===t&&/^(.)\1+$/.test(s)};let n=this.beatLength;for(let t=2;t<i.length+2;t+=2){const o=i[t%i.length];s&&h("0",o)||e&&h("2",o)?n+=2:(this.beats.push(n),n=this.beatLength)}this.timeUnit=t,this.x=0,this.y=0,this.vy=0,this.t=t}function u(t){this.propType=t.propType,this.hands=new p(t.siteswap),this.spins=(t.spinOn0s||t.spinOn2s)&&this.generateSpins(this.hands,t.spinOn0s,t.spinOn2s),this.spinIndex=0,this.spinning=!1,this.spinAmounts=[],this.spinAIndex=0,this.spinRotation=0,this.timeUnit=Math.round(t.fps/t.throwsPerSecond),this.headBounce=!!t.headBounce&&new c(this.timeUnit,this.hands.left,t.spinOn0s,t.spinOn2s),this.clubBalance=!!t.clubBalance&&new i(this.timeUnit),this.width=t.width,this.height=t.height,this.rotation=0,this.calculateScale(this.width,this.height),this.a=this.calculateAcceleration(this.scale*t.height/16*(2*this.hands.max-3),.5*this.hands.max*this.timeUnit),"b"!==this.propType&&(this.scale*=.75),this.props=new d(this.propType,this.timeUnit,this.a,this.scale,this.height),this.count=1,this.patternLength=this.hands.left.length*this.timeUnit}function f(t,i){this.type=t,this.turns=i}function g(t,i,s,e,h,n){this.propType=t,this.ssValue=i,this.t=i*h-.5*h,this.x=s,this.y=0,this.vx=(e-s)/this.t,this.vy=-n*this.t/2,"r"===t?(this.r=90-180*Math.atan(-this.vy/this.vx)/Math.PI,this.r>90&&(this.r-=180),1===Math.round(i)||2===Math.round(i)?this.r=0:(3===Math.round(i)||5===Math.round(i))&&(this.r*=.2)):"b"!==t&&(this.r=270),"i"==t?this.vr=30*(Math.random()-.5):2==i?this.vr=0:"c"===t?this.vr=360*Math.floor(Math.round(i)/2)/((i-.5)*h):"r"===t&&(this.vr=0)}function d(t,i,s,e,h){this.type=t,this.timeUnit=i,this.a=s,this.scale=e,this.height=h,this.props=[]}function m(t){this.value=t,this.active=!0}return p.prototype.getNextThrows=function(t){const i={left:[],right:[]},s=this.left[this.leftIndex][0];s.active&&0!==s.value&&(i.left=this.left[this.leftIndex]);const e=this.right[this.rightIndex][0];return e.active&&0!==e.value&&(i.right=this.right[this.rightIndex]),this.holding.left-=this.countThrownProps(i.left,!0),this.holding.right-=this.countThrownProps(i.right,!0),++this.leftIndex===this.left.length&&(this.leftIndex=0),++this.rightIndex===this.right.length&&(this.rightIndex=0),i},p.prototype.makeCatches=function(t){this.holding.left+=t.left,this.holding.right+=t.right},p.prototype.getHolding=function(t){return{left:this.holding.left,right:this.holding.right,spinning:t}},p.prototype.update=function(t,i,s,e,h){this.spinning&&0===this.positionQueue.left.x.length&&(this.spinning=!1);const n=.45*(s*e/16),o=2.5*n;if(!this.spinning&&-1===h){const s=t%(2*i)===i+1,e=t%(2*i)===Math.round(i/2+1),h=this.sync?s:t%(2*i)==1,a=this.sync?e:t%(2*i)===Math.round(3*i/2+1);let r=!1,l=!1;s?(r=0===this.catches.left[(this.leftIndex+1)%this.period].reduce(((t,i)=>t+i),0),r||(this.smoothTo("left","x",-n,Math.round(3*i/2-.5)),this.bounceToY("left",-o,Math.round(3*i/2-.5)))):e&&(r=0===this.left[this.leftIndex].reduce(((t,i)=>t+Math.abs(i)),0),r||(this.smoothTo("left","x",n,Math.round(i/2)),this.bounceToY("left",o,Math.round(i/2)))),h?(l=0===this.catches.right[(this.rightIndex+1)%this.period].reduce(((t,i)=>t+i),0),l||(this.smoothTo("right","x",n,Math.round(3*i/2-.5)),this.bounceToY("right",-o,Math.round(3*i/2-.5)))):a&&(l=0===this.right[this.rightIndex].reduce(((t,i)=>t+Math.abs(i)),0),l||(this.smoothTo("right","x",-n,Math.round(i/2)),this.bounceToY("right",o,Math.round(i/2)))),r&&Math.abs(this.positions.left.x)>.1&&this.smoothTo("left","x",0,i),l&&Math.abs(this.positions.right.x)>.1&&this.smoothTo("right","x",0,i)}this.positions.left.x=this.positionQueue.left.x.shift()||this.positions.left.x,this.positions.left.y=this.positionQueue.left.y.shift()||this.positions.left.y,this.positions.right.x=this.positionQueue.right.x.shift()||this.positions.right.x,this.positions.right.y=this.positionQueue.right.y.shift()||this.positions.right.y},p.prototype.tuckIn=function(t,i,s,e){let h={x:("left"===t?1:-1)*e,y:-2*e},n={x:("left"===t?-1:1)*e,y:0};this.positionQueue[t].x=[],this.positionQueue[t].y=[],this.smoothTo(t,"x",h.x,s/2),this.smoothTo(t,"y",h.y,s/2);const o=this.positionQueue[t].x[this.positionQueue[t].x.length-1],a=this.positionQueue[t].y[this.positionQueue[t].y.length-1];for(let e=0;e<i-s;e++)this.positionQueue[t].x.push(o),this.positionQueue[t].y.push(a);this.smoothTo(t,"x",n.x,s/2,o),this.smoothTo(t,"y",n.y,s/2,a)},p.prototype.smoothTo=function(t,i,s,e,h){let n=h||this.positions[t][i];const o=s-n;let a=0;const r=[];for(let t=0;t<e;t++)r.push(Math.sin(t*Math.PI/e)),a+=r[t];const l=o/a;for(let s=0;s<e;s++)n+=l*r[s],this.positionQueue[t][i].push(n)},p.prototype.bounceToY=function(t,i,s){this.positionQueue[t].y=[];let e=0;const h=[];for(let t=0;t<s;t++)h.push(Math.sin(Math.PI/2+t*Math.PI/s)),e+=Math.abs(h[t]);const n=i/e;let o=0;for(let i=0;i<s;i++)o+=n*h[i],this.positionQueue[t].y.push(o)},p.prototype.validateSiteswap=function(){if(this.siteswap.match(/^[a-z\d]+$/))this.type="vanilla";else if(this.siteswap.match(/^([0-9a-z]*(\[[0-9a-z]{2,}\])+[0-9a-z]*)+$/))this.type="multiplex";else if(this.siteswap.match(/^(\([02468acegikmoqsuwy]x?,[02468acegikmoqsuwy]x?\))+\*?$/))this.type="synchronous";else{if(!this.siteswap.match(/^(\(([02468acegikmoqsuwyx]x?|\[[02468acegikmoqsuwyx]{2,}\]),([02468acegikmoqsuwy]x?|\[[02468acegikmoqsuwyx]{2,}\])\))+\*?$/))return!1;this.type="synchronous multiplex"}if(this.siteswap.match(/[^a-z0-9\[\]\(\)\,\*]/))return!1;if(this.siteswap.indexOf(",")>-1&&("vanilla"==this.type||"multiplex"==this.type))return!1;if("synchronous"==this.type||"synchronous multiplex"==this.type){const t=(this.siteswap.match(/\*/g)||[]).length;if(t>1||1==t&&"*"!=this.siteswap.substring(this.siteswap.length-1,this.siteswap.length))return!1}else{if(this.siteswap.indexOf(",")>-1)return!1;if(this.siteswap.indexOf("*")>-1)return!1}if(this.siteswap.match(/\[[0-9a-z\(\),]*\[/))return!1;if(this.siteswap.match(/\[[0-9a-z\(\),]*($|\[)/))return!1;if(this.siteswap.match(/(^|\])[0-9a-z\(\),]*\]/))return!1;if(this.siteswap.match(/\[[0-9a-z]*[\(\)\,]+[0-9a-z]*\]/))return!1;if(this.siteswap.match(/\[[0-9a-z]?\]/))return!1;if("synchronous"==this.type||"synchronous multiplex"==this.type){const t=null==this.siteswap.match(/([02468acegikmoqsuwy]x)/)?0:this.siteswap.match(/([02468acegikmoqsuwy]x)/).length;if((null==this.siteswap.match(/[13579bdfhjlnprtvxz]/)?0:this.siteswap.match(/[13579bdfhjlnprtvxz]/).length)>t)return!1;if(this.siteswap.match(/(^|\))[^\(\)\*]+(\(|\*|$)/))return!1;if(this.siteswap.match(/\([0-9a-z\[\],]*($|\()/))return!1;if(this.siteswap.match(/(^|\))[0-9a-z\[\],]*\)/))return!1;if(this.siteswap.match(/\([^,]*\)/))return!1;if(this.siteswap.match(/\([0-9a-z\[\],]*,+[0-9a-z\[\],]*,+[0-9a-z\[\],]*\)/))return!1;if(this.siteswap.match(/\((([0-9a-z\[\]]+\[[0-9a-z\(\),]*\])|(\[[0-9a-z\(\),]*\][0-9a-z\[\]]+)|([0-9a-z]{3})|([0-9a-z][^x,]))?,/)||this.siteswap.match(/,(([0-9a-z\[\]]+\[[0-9a-z\(\),]*\])|(\[[0-9a-z\(\),]*\][0-9a-z\[\]]+)|([0-9a-z]{3})|([0-9a-z][^x,]))?\)/))return!1}if(this.siteswap.indexOf("*")>-1){this.siteswap=this.siteswap.substring(0,this.siteswap.length-1);let t=this.siteswap;for(;t.indexOf("(")>-1;){const i=t.indexOf("("),s=t.indexOf(","),e=t.indexOf(")");this.siteswap+="("+t.substring(s+1,e)+","+t.substring(i+1,s)+")",t=t.substring(e+1)}}let t=!1;("vanilla"==this.type&&this.siteswap.length%2==1||"multiplex"==this.type&&this.siteswap.replace(/\[\w+\]/g,"1").length%2==1)&&(t=!0,this.siteswap+=this.siteswap);const i=this;function s(t){const s=t.match(/^[0-9]$/)?parseInt(t):t.charCodeAt(0)-87;return s>i.max&&(i.max=s),s}let e=0,h=0,n=0,o=!1,a=0;for(let t=0;t<this.siteswap.length;t++){const i=this.siteswap.substring(t,t+1);if("("==i)n=1;else if(","==i)n=2;else if("["==i)o=!0;else if("]"==i)o=!1,0==n?(e++,h++,a++):1==n?e++:h++;else if(null==this.left[e]&&(this.left[e]=[]),null==this.right[h]&&(this.right[h]=[]),")"==i)n=0,this.left[e++][0]=new m(0),this.right[h++][0]=new m(0);else if(1==n){let h=s(i);h%2==0&&"x"===this.siteswap.substring(t+1,t+2)&&(h*=-1,t++),this.left[e].push(new m(h)),o||e++}else if(2==n){let e=s(i);e%2==0&&"x"===this.siteswap.substring(t+1,t+2)&&(e*=-1,t++),this.right[h].push(new m(e)),o||h++}else if(o){let n=s(i);n%2==0&&"x"===this.siteswap.substring(t+1,t+2)&&(n*=-1,t++),a%2==0?(this.left[e][this.left[e].length]=new m(n),this.right[h][0]=new m(0)):(this.right[h][this.right[h].length]=new m(n),this.left[e][0]=new m(0))}else a++%2==0?(this.left[e++][0]=new m(s(i)),this.right[h++][0]=new m(0)):(this.right[h++][0]=new m(s(i)),this.left[e++][0]=new m(0))}let r=0,l=0;for(let t=0;t<this.left.length;t++){for(let i=0;i<this.left[t].length;i++)r+=Math.abs(this.left[t][i].value);l++}for(let t=0;t<this.right.length;t++)for(let i=0;i<this.right[t].length;i++)r+=Math.abs(this.right[t][i].value);if(this.number=r/l,t&&(l/=2),r%l!=0)return!1;const p=[],c=[],u=[],f=[],g=this.left.length;for(let t=0;t<g;t++)u[t]=0,f[t]=0;for(let t=0;t<g;t++)p[t]=0===this.left[t][0].value?0:this.left[t].length,c[t]=0===this.right[t][0].value?0:this.right[t].length,this.left[t].forEach((i=>{i.value>0&&i.value%2==0?u[(t+i.value)%g]++:0!==i.value&&f[(t+Math.abs(i.value))%g]++})),this.right[t].forEach((i=>{i.value>0&&i.value%2==0?f[(t+i.value)%g]++:0!==i.value&&u[(t+Math.abs(i.value))%g]++}));for(let t=0;t<g;t++)if(u[t]!==p[t]||f[t]!==c[t])return!1;return!0},p.prototype.initCatches=function(){this.catches={left:[],right:[]};for(let t=0;t<this.period;t++)this.catches.left[t]=[],this.catches.right[t]=[];for(let t=0;t<this.period;t++)this.left[t].forEach((i=>{const s=(t+Math.abs(i.value))%this.period;0!==i.value&&i.active&&(i.value>0&&i.value%2==0?this.catches.left[s].push(i.value):this.catches.right[s].push(Math.abs(i.value)))})),this.right[t].forEach((i=>{const s=(t+Math.abs(i.value))%this.period;0!==i.value&&i.active&&(i.value>0&&i.value%2==0?this.catches.right[s].push(i.value):this.catches.left[s].push(Math.abs(i.value)))}))},p.prototype.countThrownProps=(t,i=!1)=>t.filter((t=>!i||t.active)).map((t=>0+!!t.value)).reduce(((t,i)=>t+i),0),p.prototype.initHolding=function(){const t={left:{},right:{}};let i=0;for(;this.holding.left+this.holding.right<this.number;){const s=i,e=s%this.period;this.holding.left+=this.countThrownProps(this.left[e])-(t.left[s]||0),this.holding.right+=this.countThrownProps(this.right[e])-(t.right[s]||0),this.left[e].forEach((i=>{const e=i.value,h=s+Math.abs(e);0!==e&&(e>0&&e%2==0?t.left[h]=(t.left[h]||0)+1:t.right[h]=(t.right[h]||0)+1)})),this.right[e].forEach((i=>{const e=i.value,h=s+Math.abs(e);0!==e&&(e>0&&e%2==0?t.right[h]=(t.right[h]||0)+1:t.left[h]=(t.left[h]||0)+1)})),i++}},c.prototype.update=function(t){0===this.t?(this.t=this.beats[this.beatIndex++%this.beats.length]*this.timeUnit-1,this.vy=-t*this.t/2,this.y=0):(this.vy+=t,this.y+=this.vy,this.t--,this.y>0&&(this.y=0))},c.prototype.draw=function(t,i,s,h,n,o){e(t,i+this.x,s+this.y,n,o,"#DDDDDD",h)},c.prototype.getHeadRecoil=function(){let t=0,i=.5;const s=this.timeUnit/2;if(this.t<s){const e=this.t/s-Math.PI/4;t=Math.pow(Math.sin(5*e*Math.PI/8),2)-.25,i=this.beats[this.beatIndex%this.beats.length]/4}else if(this.beats[(this.beatIndex+this.beats.length-1)%this.beats.length]*this.timeUnit-this.t<s){const e=(this.beats[(this.beatIndex+this.beats.length-1)%this.beats.length]*this.timeUnit-this.t)/s;t=Math.pow(Math.sin(Math.PI/2+3*e*Math.PI/8),2)-.25,i=this.beats[(this.beatIndex+this.beats.length-1)%this.beats.length]/4}return i>1&&(i=1),i*t},u.prototype.update=function(){let t=-1;this.spinAmounts.length>0&&0===this.spinAIndex&&(t=this.spinAmounts.length),this.hands.update(this.count,this.timeUnit,this.height,this.scale,t),this.move();const i=this.props.update();if(this.hands.makeCatches(i),this.headBounce&&this.headBounce.update(this.a),this.clubBalance&&this.clubBalance.update(this.scale,this.height),this.count%this.timeUnit==0){const t=this.hands.getNextThrows(this.spinning);this.props.makeThrows("left",t.left,this.hands),this.props.makeThrows("right",t.right,this.hands)}this.count++},u.prototype.draw=function(t){t.lineWidth=2;const i=this.width/2,s=this.scale*this.height*Math.sin(this.count/(this.timeUnit/2))/800,e=this.headBounce&&10*this.headBounce.getHeadRecoil()*this.scale;(this.rotation<=90||270<this.rotation)&&l(t,i,9*this.height/10,this.rotation+this.spinRotation,this.scale,this.height,s-e,this.hands.positions,this.propType,this.hands.getHolding(this.spinning),this.clubBalance&&this.clubBalance.getHeadReaction());const h=9*this.height/10-this.scale*this.height*41/160;this.headBounce&&this.headBounce.draw(t,i,h,this.rotation,2*this.scale,this.height),this.clubBalance&&this.clubBalance.draw(t,i,h+s-e-this.scale*this.height/20,this.scale,this.height);const n=9*this.height/10-this.scale*this.height/80;this.props.draw(t,i,n,this.rotation),90<this.rotation&&this.rotation<=270&&l(t,i,9*this.height/10,this.rotation+this.spinRotation,this.scale,this.height,s-e,this.hands.positions,this.propType,this.hands.getHolding(this.spinning),this.clubBalance&&this.clubBalance.getHeadReaction())},u.prototype.move=function(){if(this.spins&&(this.spinning&&(this.spinRotation+=this.spinAmounts[this.spinAIndex],++this.spinAIndex>=this.spinAmounts.length&&(this.spinning=!1)),this.count%this.timeUnit==this.timeUnit/2)){if(this.nextSpin)this.startSpin(this.nextSpin),delete this.nextSpin;else{const t=this.spins[this.spinIndex],i=t&&t.type;"t"===i&&this.startSpin(t),"c"===i&&(this.nextSpin=t)}++this.spinIndex>=this.spins.length&&(this.spinIndex=0)}},u.prototype.startSpin=function(t){const i=360*t.turns;let s=2*t.turns*this.timeUnit-1;"c"===t.type&&(s-=this.timeUnit/2),this.spinAmounts=[],this.spinAIndex=0;let e=0;for(let t=0;t<s;t++)this.spinAmounts[t]=Math.sin(t*Math.PI/s),e+=this.spinAmounts[t];const h=i/e;for(let t=0;t<s;t++)this.spinAmounts[t]*=h;this.spinning=!0},u.prototype.generateSpins=(t,i,s)=>{let e="";for(let i=0;i<t.period;i++){const s=t.left[i].concat(t.right[i]).map((t=>{const i=Math.abs(t.value);return i>9?9:i}));e+=Math.max(...s)}let h="";for(let n=0;n<t.period-1;n++){const o=e.slice(n,n+2);s&&["22","20"].includes(o)?(h+="c0",t.left[n].concat(t.right[n]).forEach((t=>{2===t.value&&(t.active=!1)})),t.left[n+1].concat(t.right[n+1]).forEach((t=>{2===t.value&&(t.active=!1)})),n++):i&&"00"===o?(h+="t0",n++):h+="0"}const n=[];for(let i=0;i<t.period;i++){const s=h[i];if("0"===s)n.push(!1);else{n.push(new f(s,1));for(let s=i+2;s<t.period;s+=2){if("t"!==h[s])break;n[i].turns++,n.push(!1),n.push(!1)}i=n.length-1}}return n},u.prototype.rotate=function(t){this.rotation=(this.rotation+360+t)%360},u.prototype.calculateScale=function(t,i){const s=.9*t,e=.85*i;this.scale=Math.abs(e/(i/16*(2*this.hands.max-3))),i*this.scale/4>s&&(this.scale=4*s/i)},u.prototype.calculateAcceleration=function(t,i){return 2*t/(i*i)},g.prototype.update=function(t){return this.x+=this.vx,this.vy+=t,this.y+=this.vy,this.r+=this.vr,--this.t<2?this.x<0?"left":"right":"none"},g.prototype.draw=function(t,i,s,n,o,l){const p=Math.cos(n/180*Math.PI),c=Math.sin(n/180*Math.PI),u=o*l/4;if(t.save(),t.translate(i,s),"b"==this.propType)e(t,p*this.x+c*u/3,this.y,o,l);else if("c"==this.propType)r(t,p*this.x+c*u/3,this.y,p*this.r,5*this.vx,o,l);else if("r"==this.propType){const i=this.ssValue%2==1?(this.ssValue-1)/2*this.vx:0;h(t,p*this.x+c*u/2,this.y,i,n,o,l)}else a(t,p*this.x+c*u/3,this.y,this.r,o,l);t.restore()},d.prototype.update=function(){const t={left:0,right:0};for(let i in this.props){const s=this.props[i].update(this.a);"none"!==s&&(this.props.splice(i,1),t[s]++)}return t},d.prototype.draw=function(t,i,s,e){const h=e<180?1:-1;this.props.sort((function(t,i){return t.x<i.x?h:t.x>i.x?-h:0})),this.props.forEach((h=>h.draw(t,i,s,e,this.scale,this.height)))},d.prototype.makeThrows=function(t,i,s){if(i.length<1)return;const e=i.length;let h=e>1?-.25:0;const n=this.height*this.scale/8;for(let o=0;o<e;o++){let e=i[o].value,a=!1;e<0?(a=!0,e*=-1):e%2==1&&(a=!0);let r="left"===t?3*n/4-s.positions.left.x:s.positions.right.x+3*n/4,l=n;a&&(l*=-1),"left"===t&&(r*=-1,l*=-1),this.props.push(new g(this.type,e+h,r,l,this.timeUnit,this.a)),h+=.5/i.length}},t}();
