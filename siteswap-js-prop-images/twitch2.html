<script src="tmi.min.js"></script>
<!--<script src="ss.js"></script>-->
<script src="src/Animator.js"></script>
		<script src="src/ClubBalance.js"></script>
		<script src="src/Draw.js"></script>
		<script src="src/Hands.js"></script>
		<script src="src/HeadBounce.js"></script>
		<script src="src/Juggler.js"></script>
		<script src="src/Prop.js"></script>
		<script src="src/Props.js"></script>
		<script src="src/Throw.js"></script>

		<!-- GIF export stuff -->
		<script src="src/gif/LZWEncoder.js"></script>
		<script src="src/gif/NeuQuant.js"></script>
		<script src="src/gif/GIFEncoder.js"></script>
		<script src="src/gif/b64.js"></script>
<script>
//const tmi = require('tmi.js');

			let options = {
				fps: 60,
				throwsPerSecond: 2,
				exportGif: false,
				//backgroundColour: '#FFFFFF',
				controls: false,
				debug: false,
			};
			
			let animator;

// Frontend
document.write("<canvas id='stage' width='280', height='640' style='background: rgba(0,0,0,0.6);'></canvas>");

// Define configuration options
const opts = {
  identity: {
    username: "JuggleTimBot",
    password: "oauth:q75a8pol5mul7phrr9i51as6oon43u"
  },
  channels: [
    "jugglewithtim"
  ]
};

// Create a client with our options
const client = new tmi.client(opts);

// Register our event handlers (defined below)
//client.on('message', onMessageHandler);
client.on('connected', onConnectedHandler);

// Connect to Twitch:
client.connect();

// Start animator with predefined siteswap to avoid confusion when adding an empty browser source
	canvasId = "stage";
	animator = new SiteswapJS(canvasId, "3", options);
	animator.start();


//Siteswap command
client.on('message', (channel, tags, message, self) => {
    if(self || message[0] !== '!') return;
    let parameters = message.split(' ').filter(n => n);
    let command = parameters.shift().slice(1).toLowerCase();
    if(command === 'ss') {
			//canvasId = "stage";
			siteswap = `${parameters[0]}`;
			//const options = {propType: `${parameters[1]}`}
			const options = parameters[1] ? {propType: parameters[1]} : {}
			
				//Validate siteswap
				ss = `${parameters[0]}`;
				hands = new Hands(ss);
				if (hands.validateSiteswap() === false) {
					let nope = `Invalid siteswap NotLikeThis`;
					client.say(channel, nope);
				}

				//Emote prop
				if (tags.emotes !== null) {
					emoteID = `${Object.keys(tags.emotes)[0]}`;
					//propImage.src = 'https://static-cdn.jtvnw.net/emoticons/v1/' + emoteID + '/2.0';
					propImage.src = 'https://static-cdn.jtvnw.net/emoticons/v2/' + emoteID + '/default/dark/2.0';
					const options = {propType: 'i'};
				}
				if (`${parameters[1]}` === "palooza") {
					propImage.src = 'src/images/Pinepurple.png';
				}
				if (`${parameters[1]}` === "tim") {
					propImage.src = 'src/images/ClubcrownSmall.png';
					let msg = `Heheheh, juggle WITH Tim, literally, that's funny LUL`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "matan") {
					propImage.src = 'src/images/matanj1BallOnHead.png';
					let msg = `This is matanjuggles, give them a follow! https://www.twitch.tv/matanjuggles`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "bill") {
					propImage.src = 'src/images/fitbilToon.png';
					let msg = `This is FitBill147, give them a follow! https://www.twitch.tv/fitbill147`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "stitch") {
					propImage.src = 'src/images/stitch771234.png';
					let msg = `This is stitchnuptrouble, give them a follow! https://www.twitch.tv/stitchnuptrouble`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "evan") {
					propImage.src = 'src/images/evanth5ILived.png';
					let msg = `This is EvanTheJuggler, give them a follow! https://www.twitch.tv/evanthejuggler`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "woopah") {
					propImage.src = 'src/images/evanth5WHOOPAH.png';
					let msg = `A wise man once said "Woopah". I believe his name is Evan. https://www.twitch.tv/evanthejuggler`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "flowmies") {
					propImage.src = 'src/images/flowmies.png';
					let msg = `There is so much great flow happening on Twitch, check out our team: https://www.twitch.tv/team/flowmies`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "grandma") {
					propImage.src = 'src/images/grandm59Goog.png';
					let msg = `This is Grandmasterong, give them a follow! https://www.twitch.tv/grandmasterong`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "fullpowah") {
					propImage.src = 'src/images/grandm59Fp.png';
					let msg = `When you are as strong as this grandma there are no other options than "Fullpowah"! https://www.twitch.tv/grandmasterong`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "dominic") {
					propImage.src = 'src/images/domini129Tempface.png';
					let msg = `This is dominic_coladude, give them a follow! https://www.twitch.tv/dominic_coladude`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "cat") {
					propImage.src = 'src/images/achaot1C.png';
					let msg = `The coolest cat on the block, give them a follow! https://www.twitch.tv/a_chaotic_cat`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "poop") {
					propImage.src = 'src/poop.png';
					let msg = `Eeeewww, why would you even... okay okay fine, I'll juggle it. >(`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "fishtails") {
					propImage.src = 'src/images/grandm59Ftail.png';
					let msg = `Look at me, I'm juggling fishtails! Crubb https://www.twitch.tv/grandmasterong`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "draco") {
					propImage.src = 'src/images/dracot10Anime.png';
					let msg = `This is DracoTheJuggler, give them a follow! https://www.twitch.tv/dracothejuggler`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "420691") {
					propImage.src = 'src/images/420691.png';
					let msg = `420 69 1! You know what to do, follow this dude! https://www.twitch.tv/jasonmasoud`;
					client.say(channel, msg);
				}
				if (`${parameters[1]}` === "cowbell") {
					propImage.src = 'src/images/cowbell.png';
					var audio = new Audio('src/cowbelllong.wav');
					audio.play();
					let msg = `NEEDS MORE COWBELL!`;
					client.say(channel, msg);
				}
				
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
    }
		else if(command === 'balance') {
			canvasId = "stage";
			const options = {clubBalance: true}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
			
    }
		else if(command === 'bounce') {
			canvasId = "stage";
			const options = {headBounce: true}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
    }
		else if(command === 'botplay') {
			let msg = `!play`;
			client.say(channel, msg);
    }
		else if(command === '3up360') {
			canvasId = "stage";
			siteswap = "33355500333";
			const options = {spinOn0s: true}
			//const options = parameters[1] ? {propType: parameters[1]} : {}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
    }
		else if(command === '5up360') {
			canvasId = "stage";
			siteswap = "5557777700555";
			const options = {spinOn0s: true}
			//const options = parameters[1] ? {propType: parameters[1]} : {}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
    }
		else if(command === 'getdizzy') {
			canvasId = "stage";
			siteswap = "0";
			const options = {spinOn0s: true}
			//const options = parameters[1] ? {propType: parameters[1]} : {}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
			
			let msg = `You spin me right 'round, baby, right 'round like a record, baby, right 'round, 'round, 'round`;
			client.say(channel, msg);
			
    }
		else if(command === 'glitch') {
			canvasId = "stage";
			siteswap = "[534]";
			const options = {clubBalance: true, headBounce: true, throwsPerSecond: 25}
			//const options = parameters[1] ? {propType: parameters[1]} : {}
		
			animator = new SiteswapJS(canvasId, siteswap, options);
			animator.start();
    }
});

// Called every time the bot connects to Twitch chat
function onConnectedHandler (addr, port) {
  console.log(`* Connected to ${addr}:${port}`);
}
</script>